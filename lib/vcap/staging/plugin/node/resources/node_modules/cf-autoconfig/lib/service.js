/*
 * Cloud Foundry auto-configuration
 * Service Setup
 */

var cf = require("cf-runtime");
var glob = require("glob");
var path = require("path");

function Service () {
  this.type = "";
  this.supportedModules = {};
}

Service.prototype.setup = function () {
  if (cf.CloudApp.serviceNamesOfType[this.type] === undefined) return null;

  if (cf.CloudApp.serviceNamesOfType[this.type].length !== 1) {
    console.log("Found %d %s services. Skipping auto-configuration.", cf.CloudApp.serviceNamesOfType[this.type].length, this.type);
    return null;
  }

  var props = cf.CloudApp.serviceProps[this.type];

  if (!props) return null;

  function setupModule (moduleName, cb) {
    var moduleData = null;
    try {
      moduleData = require(moduleName);
    }
    catch (e) {}
    if (moduleData !== null) {
      cb(moduleData, props);
    }
  }

  for (var moduleName in this.supportedModules) {
    var setupFunction = this.supportedModules[moduleName];

    // if module is in the basic node path
    setupModule(moduleName, setupFunction);

    // Look for modules on deeper levels
    var matches = glob.sync(path.join(process.cwd, "node_modules/**/node_modules", moduleName));

    matches.forEach(function (file) {
      file = path.resolve(path.join(process.cwd, file));
      setupModule(file, setupFunction);
    });
  }
};

exports.Service = Service;
